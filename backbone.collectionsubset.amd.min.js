/*! backbone.collectionsubset - v0.1.2 - 2014-03-26
* https://github.com/anthonyshort/backbone.collectionsubset
* Copyright (c) 2014 Anthony Short; Licensed MIT */

!function(a){"function"==typeof define&&define.amd?define(["underscore","backbone"],a):"object"==typeof exports?a(require("underscore"),require("backbone")):a(_,Backbone)}(function(a,b){(function(){b.CollectionSubset=function(){function c(b){null==b&&(b={}),b=a.defaults(b,{refresh:!0,triggers:null,filter:function(){return!0},name:null,child:null,parent:null}),this.triggers=b.triggers?b.triggers.split(" "):[],b.child||(b.child=new b.parent.constructor),this.setParent(b.parent),this.setChild(b.child),this.setFilter(b.filter),b.model&&(this.child.model=b.model),b.refresh&&this.refresh(),this.name=b.name}return c.extend=b.Model.extend,a.extend(c.prototype,b.Events),c.prototype.setParent=function(a){var b;return null!=(b=this.parent)&&b.off(null,null,this),this.parent=a,this.parent.on("add",this._onParentAdd,this),this.parent.on("remove",this._onParentRemove,this),this.parent.on("reset",this._onParentReset,this),this.parent.on("change",this._onParentChange,this),this.parent.on("dispose",this.dispose,this),this.parent.on("loading",function(a){return function(){return a.child.trigger("loading")}}(this),this),this.parent.on("ready",function(a){return function(){return a.child.trigger("ready")}}(this),this)},c.prototype.setChild=function(a){var b;return null!=(b=this.child)&&b.off(null,null,this),this.child=a,this.child.on("add",this._onChildAdd,this),this.child.on("reset",this._onChildReset,this),this.child.on("dispose",this.dispose,this),this.child.superset=this.parent,this.child.filterer=this,this.child.url=this.parent.url,this.child.model=this.parent.model},c.prototype.setFilter=function(b){var c;return c=function(a){var c,d;return c=b.call(this,a),d=this.parent.filterer?this.parent.filterer.filter(a):!0,c&&d},this.filter=a.bind(c,this)},c.prototype.refresh=function(a){var b;return null==a&&(a={}),b=this.parent.filter(this.filter),this.child.reset(b,{subset:this}),this.child.trigger("refresh")},c.prototype._replaceChildModel=function(b){var c,d;return c=this._getByCid(this.child,b.cid),c!==b?a.isUndefined(c)?this.child.add(b,{subset:this}):(d=this.child.indexOf(c),this.child.remove(c),this.child.add(b,{at:d,subset:this})):void 0},c.prototype._onParentAdd=function(a,b,c){return c&&c.subset===this?void 0:this.filter(a)?this._replaceChildModel(a):void 0},c.prototype._onParentRemove=function(a,b,c){return this.child.remove(a,c)},c.prototype._onParentReset=function(){return this.refresh()},c.prototype._onParentChange=function(a){return this.triggerMatched(a)?this.filter(a)?this.child.add(a):this.child.remove(a):void 0},c.prototype._onChildAdd=function(a,b,c){var d;if((!c||c.subset!==this)&&(this.parent.add(a),d=this._getByCid(this.parent,a.cid)))return this.filter(d)?this._replaceChildModel(d):this.child.remove(a)},c.prototype._onChildReset=function(a,b){return b&&b.subset===this?void 0:(this.parent.add(this.child.models),this.refresh())},c.prototype._getByCid=function(a,b){var c;return c=a.getByCid||a.get,c.apply(a,[b])},c.prototype.triggerMatched=function(b){var c;return 0===this.triggers.length?!0:b.hasChanged()?(c=a.keys(b.changedAttributes()),a.intersection(this.triggers,c).length>0):!1},c.prototype.dispose=function(){var a,b,c,d,e;if(!this.disposed){for(this.trigger("dispose",this),this.parent.off(null,null,this),this.child.off(null,null,this),"function"==typeof(b=this.child).dispose&&b.dispose(),this.off(),e=["parent","child","options"],c=0,d=e.length;d>c;c++)a=e[c],delete this[a];return this.disposed=!0}},c}(),b.Collection.prototype.subcollection=function(c){var d;return null==c&&(c={}),a.defaults(c,{child:new this.constructor,parent:this}),d=new b.CollectionSubset(c),d.child},"undefined"!=typeof module&&null!==module&&(module.exports=b.CollectionSubset)}).call(this)});