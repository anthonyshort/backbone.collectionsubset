/*! backbone.collectionsubset - v0.1.4 - 2015-07-10\n* https://github.com/anthonyshort/backbone.collectionsubset
* Copyright (c) 2015 Anthony Short; Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?
// AMD. Register as an anonymous module unless amdModuleId is set
define(["backbone","underscore"],function(a,c){return b(a,c)}):"object"==typeof exports?
// Node. Does not work with strict CommonJS, but
// only CommonJS-like environments that support module.exports,
// like Node.
module.exports=b(require("backbone"),require("underscore")):b(backbone,underscore)}(this,function(a,b){(function(){Backbone.CollectionSubset=function(){function a(a){null==a&&(a={}),a=_.defaults(a,{refresh:!0,triggers:null,filter:function(){return!0},name:null,child:null,parent:null}),this.triggers=a.triggers?a.triggers.split(" "):[],a.child||(a.child=new a.parent.constructor),this.setParent(a.parent),this.setChild(a.child),this.setFilter(a.filter),a.model&&(this.child.model=a.model),a.refresh&&this.refresh(),this.name=a.name}return a.extend=Backbone.Model.extend,_.extend(a.prototype,Backbone.Events),a.prototype.setParent=function(a){var b;return null!=(b=this.parent)&&b.off(null,null,this),this.parent=a,this.parent.on("add",this._onParentAdd,this),this.parent.on("remove",this._onParentRemove,this),this.parent.on("reset",this._onParentReset,this),this.parent.on("change",this._onParentChange,this),this.parent.on("dispose",this.dispose,this),this.parent.on("loading",function(a){return function(){return a.child.trigger("loading")}}(this),this),this.parent.on("sync error",function(a){return function(){return a.child.trigger("loaded")}}(this),this)},a.prototype.setChild=function(a){var b;return null!=(b=this.child)&&b.off(null,null,this),this.child=a,this.child.on("add",this._onChildAdd,this),this.child.on("reset",this._onChildReset,this),this.child.on("dispose",this.dispose,this),this.child.superset=this.parent,this.child.filterer=this,this.child.url=this.parent.url,this.child.model=this.parent.model},a.prototype.setFilter=function(a){var b;return b=function(b){var c,d;return c=a.call(this,b),d=this.parent.filterer?this.parent.filterer.filter(b):!0,c&&d},this.filter=_.bind(b,this)},a.prototype.refresh=function(a){var b;return null==a&&(a={}),b=this.parent.filter(this.filter),this.child.reset(b,{subset:this}),this.child.trigger("refresh")},a.prototype._replaceChildModel=function(a){var b,c;return b=this._getByCid(this.child,a.cid),b!==a?_.isUndefined(b)?this.child.add(a,{subset:this}):(c=this.child.indexOf(b),this.child.remove(b),this.child.add(a,{at:c,subset:this})):void 0},a.prototype._onParentAdd=function(a,b,c){return c&&c.subset===this?void 0:this.filter(a)?this._replaceChildModel(a):void 0},a.prototype._onParentRemove=function(a,b,c){return this.child.remove(a,c)},a.prototype._onParentReset=function(a,b){return this.refresh()},a.prototype._onParentChange=function(a,b){return this.triggerMatched(a)?this.filter(a)?this.child.add(a):this.child.remove(a):void 0},a.prototype._onChildAdd=function(a,b,c){var d;if((!c||c.subset!==this)&&(this.parent.add(a),d=this._getByCid(this.parent,a.cid)))return this.filter(d)?this._replaceChildModel(d):this.child.remove(a)},a.prototype._onChildReset=function(a,b){return b&&b.subset===this?void 0:(this.parent.add(this.child.models),this.refresh())},a.prototype._getByCid=function(a,b){var c;return c=a.getByCid||a.get,c.apply(a,[b])},a.prototype.triggerMatched=function(a){var b;return 0===this.triggers.length?!0:a.hasChanged()?(b=_.keys(a.changedAttributes()),_.intersection(this.triggers,b).length>0):!1},a.prototype.dispose=function(){var a,b,c,d,e;if(!this.disposed){for(this.trigger("dispose",this),this.parent.off(null,null,this),this.child.off(null,null,this),"function"==typeof(a=this.child).dispose&&a.dispose(),this.off(),e=["parent","child","options"],b=0,c=e.length;c>b;b++)d=e[b],delete this[d];return this.disposed=!0}},a}(),Backbone.Collection.prototype.subcollection=function(a){var b;return null==a&&(a={}),_.defaults(a,{child:new this.constructor,parent:this}),b=new Backbone.CollectionSubset(a),b.child},"undefined"!=typeof module&&null!==module&&(module.exports=Backbone.CollectionSubset)}).call(this)});